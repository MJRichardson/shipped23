name: Release - Pull Request

on:
  pull_request:
    branches: [ "main" ]

env:
  OCTOPUS_SPACE: 'SHIPPED23'

jobs:
  build-and-push-image:
    uses: MJRichardson/shipped23/.github/workflows/build-and-push-image.yaml@provision-env

  provision-environment-and-deploy:
    permissions:
      id-token: write # This is required for requesting the JWT
    runs-on: ubuntu-latest
    needs: build-and-push-image

    steps:
     - name: Login to Octopus üêô
       uses: OctopusDeploy/login@v1
       with:
         server: https://michrich.octopus.app
         service_account_id: 1269d528-af54-4ab9-8a4b-902ac894a865

     - name: Provision branch environment üêô
       id: provision-branch-environment
       uses: OctopusDeploy/run-runbook-action@v3
       with:
         project: 'SHIPPED23'
         runbook: 'Create branch environment'
         variables: |
          Branch:${{needs.build-and-push-image.outputs.branch}}
         environments: |
           Branch Template

     - name: Wait for environment to provision üêô
       uses: OctopusDeploy/await-task-action@v3
       with:
         server_task_id: ${{ steps.provision-branch-environment.outputs.server_tasks[0].serverTaskId }}